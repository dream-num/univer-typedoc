name: ðŸ“¤ Deploy Staging

on:
  workflow_dispatch:
    inputs:
      image-tag:
        description: The image tag to deploy
        type: string
        default: latest
        required: false
  push:
    branches:
      - ci/deploy

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    if: inputs.image-tag == ''
    uses: ./.github/workflows/build.yml
    secrets: inherit

  deploy:
    if: inputs.image-tag == ''
    runs-on: arc-runner-set
    needs: build
    steps:
      - uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          repository: dream-num/helm-chart-private
          event-type: dispatch
          client-payload: '{"service":"univer-typedoc","tag":"${{ needs.build.outputs.image-tag }}"}'

  deploy-trigger:
    if: inputs.image-tag != ''
    runs-on: arc-runner-set
    steps:
      - uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          repository: dream-num/helm-chart-private
          event-type: dispatch
          client-payload: '{"service":"univer-typedoc","tag":"${{ inputs.image-tag }}"}'
